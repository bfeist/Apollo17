<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content="template" />
	<link rel="shortcut icon" href="/favicon.ico" />
	<link rel="copyright" href="http://creativecommons.org/licenses/by-nc-sa/3.0/" />

	<title>TOC</title>
	<meta name="robots" content="index,follow" />
	<style type="text/css" media="screen,projection"></style>
	<link rel="stylesheet" type="text/css" href="styles.css" />
    <script type="text/javascript" src="lib/date.js"></script>
    <script type="text/javascript" src="lib/jquery-2.1.3.js"></script>
    <script type="text/javascript" src="lib/jquery_plugins.js"></script>
    <script type='text/javascript' src='http://www.youtube.com/iframe_api'></script>

    <script language="javascript" type="text/javascript">
		var gLastTimeIdMarker= '';
		var gLastTimeIdChecked = '';
        var gCurrMissionTime = '';
        var gCurrMissionDate = null;
		var gIntervalID = null;
		var gYTList = [];
		var gCurrVideoStartSeconds = 0;
        var gCurrVideoEndSeconds = 0;

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'ccHq1hv0ohk',
                width: '100%',
                height: '100%',
                frameborder: '0',
                iv_load_policy: 3,
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
            seekToTime("timeid0000000");
        }

        // The API calls this function when the player's state changes.
        // The function indicates that when playing a video (state=1)
        var initialPlay = true;
        function onPlayerStateChange(event) {
            console.log("player state change: " + event.data);
            if (event.data == YT.PlayerState.PLAYING && initialPlay) {
				player.seekTo(0, true);
				initialPlay = false;
			}
            if (event.data == YT.PlayerState.PLAYING && gIntervalID == null ) {
				//poll for mission time scrolling if video is playing
				gIntervalID = setAutoScrollPoller();
				console.log("PLAYING: interval started: " + gIntervalID);
			} else if (event.data == YT.PlayerState.PAUSED) {
				//clear polling for mission time scrolling if video is paused
				window.clearInterval(gIntervalID);
				console.log("PAUSED: interval stopped: " + gIntervalID);
				gIntervalID = null;
			}
            if (event.data == YT.PlayerState.BUFFERING) {
                console.log("BUFFERING: " + event.target.getCurrentTime() + gCurrVideoStartSeconds);
                findClosestUtterance(event.target.getCurrentTime() + gCurrVideoStartSeconds);
            }
            if (event.data == YT.PlayerState.ENDED) { //load next video
                console.log("ENDED. Load next video.");
                var currVideoID = player.getVideoUrl().substr(32,11);
                var secsPositiveMultiplier = 1;
                for (var i = 0; i < gYTList.length; ++i) {
                    if (gYTList[i][1] == currVideoID) {
                        console.log("Changing YT video from: " + currVideoID + " to: " + gYTList[i + 1][1]);
                        currVideoID = gYTList[i + 1][1];
                        break;
                    }
                }
                var itemStartTimeArray = gYTList[i + 1][2].split(":");
                var startHours = parseInt(itemStartTimeArray[0]);
                var startMinutes = parseInt(itemStartTimeArray[1]);
                var startSeconds = parseInt(itemStartTimeArray[2]);
                secsPositiveMultiplier = (startHours < 0) ? -1 : 1;
                gCurrVideoStartSeconds = secsPositiveMultiplier * (Math.abs(startHours) * 60 * 60 + startMinutes  * 60 + startSeconds);

                var itemEndTimeArray = gYTList[i + 1][3].split(":");
                var endHours = parseInt(itemEndTimeArray[0]);
                var endMinutes = parseInt(itemEndTimeArray[1]);
                var endSeconds = parseInt(itemEndTimeArray[2]);
                secsPositiveMultiplier = (endHours < 0) ? -1 : 1;
                gCurrVideoEndSeconds = secsPositiveMultiplier * (Math.abs(endHours) * 60 * 60 + endMinutes * 60 + endSeconds);

                player.loadVideoById(currVideoID, 0);
                player.iv_load_policy = 3;

                window.clearInterval(gIntervalID); //reset the scrolling poller for the new video
                gIntervalID = setAutoScrollPoller();
            }
		}

        //--------------- search for closest utterance time to video time (used upon seeked video) --------------------
        function findClosestUtterance(totalSecSearch) {
            var found = false;
            var onCountdown = false;
            var curSecSearch = totalSecSearch;
            var transcriptFrame = $('#iFrameTranscript').contents();
            if (totalSecSearch < 0) {
                onCountdown = true; //if on the countdown video counting backwards, make all times positive for timecode generation, then add the negative to the search string
            }
            while (!found) {
                var hours = Math.abs(parseInt(curSecSearch / 3600));
                var minutes = Math.abs(parseInt(curSecSearch / 60)) % 60;
                var seconds = Math.abs(parseInt(curSecSearch)) % 60;
                seconds = Math.floor(seconds);

                var timeId = (hours < 10 ? "00" + hours : hours < 100 ? "0" + hours : hours) +
                        (minutes < 10 ? "0" + minutes : minutes) +
                        (seconds < 10 ? "0" + seconds : seconds);
                timeId = "timeid" + timeId;
                if (onCountdown) {
                    timeId = timeId.substr(0,6) + "-" + timeId.substr(7); //change timeid to negative, replacing leading tripple hours zero with "-"
                }

                if (transcriptFrame.find('#' + timeId).exists()) {
                    found = true;
                    console.log("found: " + timeId);
                    scrollToTimeID(timeId);
                    break;
                } else {
                    //console.log("not found: " + timeId);
                    if (gCurrVideoStartSeconds >= 0) {
                        curSecSearch--;
                    } else {
                        curSecSearch++; //if we're on the countdown, search forward in time for the closest utterance
                    }
                }
            }
        }

		//--------------- transcript iframe autoscroll handling --------------------
		function setAutoScrollPoller() {
			return window.setInterval(function () {
                var onCountdown = false;
				var totalSec = player.getCurrentTime() + gCurrVideoStartSeconds + 0.5;
                if (totalSec < 0) {
                    onCountdown = true; //if on the countdown video counting backwards, make all times positive for timecode generation, then add the negative to the search string
                }
				var hours = Math.abs(parseInt(totalSec / 3600));
				var minutes = Math.abs(parseInt(totalSec / 60)) % 60 % 60;
				var seconds = Math.abs(parseInt(totalSec)) % 60;
				seconds = Math.floor(seconds);

                gCurrMissionTime = " " + (hours < 10 ? "00" + hours : hours < 100 ? "0" + hours : hours) + ":" +
                        (minutes < 10 ? "0" + minutes : minutes) + ":" +
                        (seconds < 10 ? "0" + seconds : seconds);

                var timeId = "timeid" + (hours < 10 ? "00" + hours : hours < 100 ? "0" + hours : hours) +
                        (minutes < 10 ? "0" + minutes : minutes) +
                        (seconds < 10 ? "0" + seconds : seconds);

                if (onCountdown) {
                    timeId = timeId.substr(0,6) + "-" + timeId.substr(7); //change timeid to negative, replacing leading tripple zero hours with "-"
                    gCurrMissionTime = "-" + gCurrMissionTime.substr(2);
                }
                timer.innerText = gCurrMissionTime;

				if (timeId != gLastTimeIdChecked) {
					//console.log("totalsec: " + totalSec + "| divmarker: " + timeId);
					gLastTimeIdChecked = timeId;
					scrollToTimeID(timeId);
                    missionTimeHistoricalDifference();
				}
			}, 500); //polling frequency in milliseconds
		}
		function scrollToTimeID(timeId) {
			//console.log ('#' + timeId + ' - ' + $('#iFrameTranscript').contents().find('#' + timeId).length);
			var transcriptFrame = $('#iFrameTranscript').contents();
            var timeIdMarker = transcriptFrame.find('#' + timeId);
			if (timeIdMarker.exists()) {
				//reset background color of last line
				if (gLastTimeIdMarker != '') {
                    gLastTimeIdMarker.css("background-color","#FFFFFF");
				}
				var scrollDestination = timeIdMarker.offset().top - 50;
				timeIdMarker.css("background-color","#DDDDDD");
                gLastTimeIdMarker = timeIdMarker;
				transcriptFrame.find('body').animate({ scrollTop: scrollDestination }, 300);
			}
		}
        function missionTimeHistoricalDifference() {
            var launchDate = Date.parse("1971-12-07 12:33am");

            var currMissionTimeArray = gCurrMissionTime.split(":");
            var currMissionHours = parseInt(currMissionTimeArray[0]);
            var currMissionMinutes = parseInt(currMissionTimeArray[1]);
            var currMissionSeconds = parseInt(currMissionTimeArray[2]);
            if (parseInt(currMissionHours) >= 0) {
                gCurrMissionDate = launchDate.add({
                    hours: currMissionHours,
                    minutes: currMissionMinutes,
                    seconds: currMissionSeconds
                });
            } else { //if on countdown, subtract the mission time from the launch moment
                gCurrMissionDate = launchDate.subtract({
                    hours: currMissionHours,
                    minutes: currMissionMinutes,
                    seconds: currMissionSeconds
                });
            }
            var custom_date_formats = {past: [{ ceiling: null, text: "$years years, $months months, $days days, $hours hours, $minutes minutes, $seconds seconds ago" }]}
            var humanizedRealtimeDifference = humanized_time_span(gCurrMissionDate, Date.now(), custom_date_formats);
            historicalTimeDiff.innerText = "Exactly " + humanizedRealtimeDifference;

//            console.log("currMissionTime: " + gCurrMissionTime);
//            console.log("currMissionDate: " + gCurrMissionDate);
//            console.log("Exactly " + humanizedRealtimeDifference);
        }

		//--------------- transcript click handling --------------------
		function seekToTime(elementId){
            var secsPositiveMultiplier = 1;
            var timeStr = elementId.substr(6,7);
            var sign = timeStr.substr(0,1);
            var hours = parseInt(timeStr.substr(0,3));
            var minutes = parseInt(timeStr.substr(3,2));
            var seconds = parseInt(timeStr.substr(5,2));
            secsPositiveMultiplier = (sign == "-") ? -1 : 1;
            var totalSeconds = secsPositiveMultiplier * ((Math.abs(hours) * 60 * 60) + (minutes * 60) + seconds);

			var currVideoID = player.getVideoUrl().substr(32,11);
			//console.log(currVideoID);
			for (var i = 0; i < gYTList.length; ++i) {
				var itemStartTimeArray = gYTList[i][2].split(":");
                var startHours = parseInt(itemStartTimeArray[0]);
                var startMinutes = parseInt(itemStartTimeArray[1]);
                var startSeconds = parseInt(itemStartTimeArray[2]);
                secsPositiveMultiplier = (startHours < 0) ? -1 : 1;
                var itemStartTimeSeconds = secsPositiveMultiplier * (Math.abs(startHours) * 60 * 60 + startMinutes  * 60 + startSeconds);

                var itemEndTimeArray = gYTList[i][3].split(":");
                var endHours = parseInt(itemEndTimeArray[0]);
                var endMinutes = parseInt(itemEndTimeArray[1]);
                var endSeconds = parseInt(itemEndTimeArray[2]);
                secsPositiveMultiplier = (endHours < 0) ? -1 : 1;
                var itemEndTimeSeconds = secsPositiveMultiplier * (Math.abs(endHours) * 60 * 60 + endMinutes * 60 + endSeconds);

                if (totalSeconds >= itemStartTimeSeconds && totalSeconds < itemEndTimeSeconds) { //if this YT video in loop contains the time we want to seek to
					var seekToSecondsWithOffset = totalSeconds - itemStartTimeSeconds;
                    //adjust for 000:02:40 time addition at 065:00:00 -- only the 65 hours-in video needs this manual adjustment, all others have their startTime listed including the time change
                    if (itemStartTimeSeconds == 230400) {
                        if (seekToSecondsWithOffset > 3600) { //if at 065:00:00 or greater, add 000:02:40 to time
                            seekToSecondsWithOffset = seekToSecondsWithOffset - 9600;
                        }
                    }
					gCurrVideoStartSeconds = itemStartTimeSeconds;
                    gCurrVideoEndSeconds = itemEndTimeSeconds;
                    //change youtube video if the correct video isn't already playing
					if (currVideoID !== gYTList[i][1]) {
                        console.log("changing YT video from: " + currVideoID + " to: " + gYTList[i][1]);
						player.loadVideoById(gYTList[i][1], seekToSecondsWithOffset);
						window.clearInterval(gIntervalID); //reset the scrolling poller for the new video
						gIntervalID = setAutoScrollPoller();
					} else {
                        console.log("no need to change video. Seeking to " + elementId.toString());
						player.seekTo(seekToSecondsWithOffset, true);
					}
					break;
				}
			}
		}

		//--------------- youtube index file handling --------------------
		$(document).ready(function() {
			$.ajax({
				type: "GET",
				url: "./YouTube_media_index.csv",
				dataType: "text",
				success: function(data) {processYTData(data);}
			});
		});

		function processYTData(allText) {
			var allTextLines = allText.split(/\r\n|\n/);

			for (var i = 0; i < allTextLines.length; i++) {
				var data = allTextLines[i].split('|');

				var rec = [];
				rec.push(data[0]);
				rec.push(data[1]);
				rec.push(data[2]);
				rec.push(data[3]);
				gYTList.push(rec);
			}
			// alert(lines);
		}

        $(document).ready(function() {
            var $w = $(window),
                    $vids = $("iframe[src*='youtube']");

            // Store video aspect ratio
            // Store video aspect ratio
            $vids.each(function() {
                var aspectRatio = $(this).width() / $(this).height();
                $(this).attr("data-aspect-ratio", aspectRatio);
            });

            $w.resize(function() {
                // Set video width fluidly
                $vids.each(function() {
                    $(this).width($(this).parent().width());
                    $(this).height(Math.floor($(this).width() / $(this).data("aspect-ratio")));
                });
            }).resize();
        });
		
    </script>
</head>
<body>
<section>
    <div class="main">
        <iframe src="TOC.html" id="iFrameTOC" name="iFrameTOC" scrolling="yes" height="100%" width="100%"></iframe>
    </div>
    <div class="main">
        <div id="player">
            <iframe src="http://www.youtube.com/embed/ccHq1hv0ohk?rel=0" frameborder="0" allowfullscreen width="100%" height="100%"></iframe>
        </div>
    </div>
    <div class="main">
        <iframe src="allUtterances.html" name="iFrameTranscript" id="iFrameTranscript" scrolling="yes" height="100%" width="100%"></iframe>
    </div>
    <div class="main">
        <div id="timer">00</div>
        <div id="historicalTimeDiff">00</div>
    </div>
</section>
</body>
</html>